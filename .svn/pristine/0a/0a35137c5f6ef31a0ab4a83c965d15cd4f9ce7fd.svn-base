function XmlHttp(){}function XmlDocument(){}function hex_sha1(t){return rstr2hex(rstr_sha1(str2rstr_utf8(t)))}function b64_sha1(t){return rstr2b64(rstr_sha1(str2rstr_utf8(t)))}function any_sha1(t,e){return rstr2any(rstr_sha1(str2rstr_utf8(t)),e)}function hex_hmac_sha1(t,e){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)))}function b64_hmac_sha1(t,e){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)))}function any_hmac_sha1(t,e,n){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(t),str2rstr_utf8(e)),n)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(t){return binb2rstr(binb_sha1(rstr2binb(t),8*t.length))}function rstr_hmac_sha1(t,e){var n=rstr2binb(t);n.length>16&&(n=binb_sha1(n,8*t.length));for(var r=Array(16),i=Array(16),s=0;s<16;s++)r[s]=909522486^n[s],i[s]=1549556828^n[s];var o=binb_sha1(r.concat(rstr2binb(e)),512+8*e.length);return binb2rstr(binb_sha1(i.concat(o),672))}function rstr2binb(t){for(var e=Array(t.length>>2),n=0;n<e.length;n++)e[n]=0;for(var n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<24-n%32;return e}function binb2rstr(t){for(var e="",n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>24-n%32&255);return e}function binb_sha1(t,e){t[e>>5]|=128<<24-e%32,t[(e+64>>9<<4)+15]=e;for(var n=Array(80),r=1732584193,i=-271733879,s=-1732584194,o=271733878,a=-1009589776,h=0;h<t.length;h+=16){for(var c=r,l=i,u=s,d=o,_=a,g=0;g<80;g++){g<16?n[g]=t[h+g]:n[g]=bit_rol(n[g-3]^n[g-8]^n[g-14]^n[g-16],1);var p=safe_add(safe_add(bit_rol(r,5),sha1_ft(g,i,s,o)),safe_add(safe_add(a,n[g]),sha1_kt(g)));a=o,o=s,s=bit_rol(i,30),i=r,r=p}r=safe_add(r,c),i=safe_add(i,l),s=safe_add(s,u),o=safe_add(o,d),a=safe_add(a,_)}return Array(r,i,s,o,a)}function sha1_ft(t,e,n,r){return t<20?e&n|~e&r:t<40?e^n^r:t<60?e&n|e&r|n&r:e^n^r}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function hex_md5(t){return rstr2hex(rstr_md5(str2rstr_utf8(t)))}function b64_md5(t){return rstr2b64(rstr_md5(str2rstr_utf8(t)))}function any_md5(t,e){return rstr2any(rstr_md5(str2rstr_utf8(t)),e)}function hex_hmac_md5(t,e){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)))}function b64_hmac_md5(t,e){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)))}function any_hmac_md5(t,e,n){return rstr2any(rstr_hmac_md5(str2rstr_utf8(t),str2rstr_utf8(e)),n)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(t){return binl2rstr(binl_md5(rstr2binl(t),8*t.length))}function rstr_hmac_md5(t,e){var n=rstr2binl(t);n.length>16&&(n=binl_md5(n,8*t.length));for(var r=Array(16),i=Array(16),s=0;s<16;s++)r[s]=909522486^n[s],i[s]=1549556828^n[s];var o=binl_md5(r.concat(rstr2binl(e)),512+8*e.length);return binl2rstr(binl_md5(i.concat(o),640))}function rstr2hex(t){try{}catch(e){hexcase=0}for(var n,r=hexcase?"0123456789ABCDEF":"0123456789abcdef",i="",s=0;s<t.length;s++)n=t.charCodeAt(s),i+=r.charAt(n>>>4&15)+r.charAt(15&n);return i}function rstr2b64(t){try{}catch(e){b64pad=""}for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r="",i=t.length,s=0;s<i;s+=3)for(var o=t.charCodeAt(s)<<16|(s+1<i?t.charCodeAt(s+1)<<8:0)|(s+2<i?t.charCodeAt(s+2):0),a=0;a<4;a++)r+=8*s+6*a>8*t.length?b64pad:n.charAt(o>>>6*(3-a)&63);return r}function rstr2any(t,e){var n,r,i,s,o,a=e.length,h=Array(Math.ceil(t.length/2));for(n=0;n<h.length;n++)h[n]=t.charCodeAt(2*n)<<8|t.charCodeAt(2*n+1);var c=Math.ceil(8*t.length/(Math.log(e.length)/Math.log(2))),l=Array(c);for(r=0;r<c;r++){for(o=Array(),s=0,n=0;n<h.length;n++)s=(s<<16)+h[n],i=Math.floor(s/a),s-=i*a,(o.length>0||i>0)&&(o[o.length]=i);l[r]=s,h=o}var u="";for(n=l.length-1;n>=0;n--)u+=e.charAt(l[n]);return u}function str2rstr_utf8(t){for(var e,n,r="",i=-1;++i<t.length;)e=t.charCodeAt(i),n=i+1<t.length?t.charCodeAt(i+1):0,55296<=e&&e<=56319&&56320<=n&&n<=57343&&(e=65536+((1023&e)<<10)+(1023&n),i++),e<=127?r+=String.fromCharCode(e):e<=2047?r+=String.fromCharCode(192|e>>>6&31,128|63&e):e<=65535?r+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|63&e):e<=2097151&&(r+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|63&e));return r}function str2rstr_utf16le(t){for(var e="",n=0;n<t.length;n++)e+=String.fromCharCode(255&t.charCodeAt(n),t.charCodeAt(n)>>>8&255);return e}function str2rstr_utf16be(t){for(var e="",n=0;n<t.length;n++)e+=String.fromCharCode(t.charCodeAt(n)>>>8&255,255&t.charCodeAt(n));return e}function rstr2binl(t){for(var e=Array(t.length>>2),n=0;n<e.length;n++)e[n]=0;for(var n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<n%32;return e}function binl2rstr(t){for(var e="",n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>n%32&255);return e}function binl_md5(t,e){t[e>>5]|=128<<e%32,t[(e+64>>>9<<4)+14]=e;for(var n=1732584193,r=-271733879,i=-1732584194,s=271733878,o=0;o<t.length;o+=16){var a=n,h=r,c=i,l=s;n=md5_ff(n,r,i,s,t[o+0],7,-680876936),s=md5_ff(s,n,r,i,t[o+1],12,-389564586),i=md5_ff(i,s,n,r,t[o+2],17,606105819),r=md5_ff(r,i,s,n,t[o+3],22,-1044525330),n=md5_ff(n,r,i,s,t[o+4],7,-176418897),s=md5_ff(s,n,r,i,t[o+5],12,1200080426),i=md5_ff(i,s,n,r,t[o+6],17,-1473231341),r=md5_ff(r,i,s,n,t[o+7],22,-45705983),n=md5_ff(n,r,i,s,t[o+8],7,1770035416),s=md5_ff(s,n,r,i,t[o+9],12,-1958414417),i=md5_ff(i,s,n,r,t[o+10],17,-42063),r=md5_ff(r,i,s,n,t[o+11],22,-1990404162),n=md5_ff(n,r,i,s,t[o+12],7,1804603682),s=md5_ff(s,n,r,i,t[o+13],12,-40341101),i=md5_ff(i,s,n,r,t[o+14],17,-1502002290),r=md5_ff(r,i,s,n,t[o+15],22,1236535329),n=md5_gg(n,r,i,s,t[o+1],5,-165796510),s=md5_gg(s,n,r,i,t[o+6],9,-1069501632),i=md5_gg(i,s,n,r,t[o+11],14,643717713),r=md5_gg(r,i,s,n,t[o+0],20,-373897302),n=md5_gg(n,r,i,s,t[o+5],5,-701558691),s=md5_gg(s,n,r,i,t[o+10],9,38016083),i=md5_gg(i,s,n,r,t[o+15],14,-660478335),r=md5_gg(r,i,s,n,t[o+4],20,-405537848),n=md5_gg(n,r,i,s,t[o+9],5,568446438),s=md5_gg(s,n,r,i,t[o+14],9,-1019803690),i=md5_gg(i,s,n,r,t[o+3],14,-187363961),r=md5_gg(r,i,s,n,t[o+8],20,1163531501),n=md5_gg(n,r,i,s,t[o+13],5,-1444681467),s=md5_gg(s,n,r,i,t[o+2],9,-51403784),i=md5_gg(i,s,n,r,t[o+7],14,1735328473),r=md5_gg(r,i,s,n,t[o+12],20,-1926607734),n=md5_hh(n,r,i,s,t[o+5],4,-378558),s=md5_hh(s,n,r,i,t[o+8],11,-2022574463),i=md5_hh(i,s,n,r,t[o+11],16,1839030562),r=md5_hh(r,i,s,n,t[o+14],23,-35309556),n=md5_hh(n,r,i,s,t[o+1],4,-1530992060),s=md5_hh(s,n,r,i,t[o+4],11,1272893353),i=md5_hh(i,s,n,r,t[o+7],16,-155497632),r=md5_hh(r,i,s,n,t[o+10],23,-1094730640),n=md5_hh(n,r,i,s,t[o+13],4,681279174),s=md5_hh(s,n,r,i,t[o+0],11,-358537222),i=md5_hh(i,s,n,r,t[o+3],16,-722521979),r=md5_hh(r,i,s,n,t[o+6],23,76029189),n=md5_hh(n,r,i,s,t[o+9],4,-640364487),s=md5_hh(s,n,r,i,t[o+12],11,-421815835),i=md5_hh(i,s,n,r,t[o+15],16,530742520),r=md5_hh(r,i,s,n,t[o+2],23,-995338651),n=md5_ii(n,r,i,s,t[o+0],6,-198630844),s=md5_ii(s,n,r,i,t[o+7],10,1126891415),i=md5_ii(i,s,n,r,t[o+14],15,-1416354905),r=md5_ii(r,i,s,n,t[o+5],21,-57434055),n=md5_ii(n,r,i,s,t[o+12],6,1700485571),s=md5_ii(s,n,r,i,t[o+3],10,-1894986606),i=md5_ii(i,s,n,r,t[o+10],15,-1051523),r=md5_ii(r,i,s,n,t[o+1],21,-2054922799),n=md5_ii(n,r,i,s,t[o+8],6,1873313359),s=md5_ii(s,n,r,i,t[o+15],10,-30611744),i=md5_ii(i,s,n,r,t[o+6],15,-1560198380),r=md5_ii(r,i,s,n,t[o+13],21,1309151649),n=md5_ii(n,r,i,s,t[o+4],6,-145523070),s=md5_ii(s,n,r,i,t[o+11],10,-1120210379),i=md5_ii(i,s,n,r,t[o+2],15,718787259),r=md5_ii(r,i,s,n,t[o+9],21,-343485551),n=safe_add(n,a),r=safe_add(r,h),i=safe_add(i,c),s=safe_add(s,l)}return Array(n,r,i,s)}function md5_cmn(t,e,n,r,i,s){return safe_add(bit_rol(safe_add(safe_add(e,t),safe_add(r,s)),i),n)}function md5_ff(t,e,n,r,i,s,o){return md5_cmn(e&n|~e&r,t,e,i,s,o)}function md5_gg(t,e,n,r,i,s,o){return md5_cmn(e&r|n&~r,t,e,i,s,o)}function md5_hh(t,e,n,r,i,s,o){return md5_cmn(e^n^r,t,e,i,s,o)}function md5_ii(t,e,n,r,i,s,o){return md5_cmn(n^(e|~r),t,e,i,s,o)}function safe_add(t,e){var n=(65535&t)+(65535&e),r=(t>>16)+(e>>16)+(n>>16);return r<<16|65535&n}function bit_rol(t,e){return t<<e|t>>>32-e}function utf8t2d(t){t=t.replace(/\r\n/g,"\n");var e=new Array,n=String.fromCharCode(237);if(n.charCodeAt(0)<0)for(var r=0;r<t.length;r++){var i=t.charCodeAt(r);i>0?e[e.length]=i:(e[e.length]=256+i>>6|192,e[e.length]=256+i&63|128)}else for(var r=0;r<t.length;r++){var i=t.charCodeAt(r);i<128?e[e.length]=i:i>127&&i<2048?(e[e.length]=i>>6|192,e[e.length]=63&i|128):(e[e.length]=i>>12|224,e[e.length]=i>>6&63|128,e[e.length]=63&i|128)}return e}function utf8d2t(t){for(var e=new Array,n=0;n<t.length;)t[n]<128?(e[e.length]=String.fromCharCode(t[n]),n++):t[n]>191&&t[n]<224?(e[e.length]=String.fromCharCode((31&t[n])<<6|63&t[n+1]),n+=2):(e[e.length]=String.fromCharCode((15&t[n])<<12|(63&t[n+1])<<6|63&t[n+2]),n+=3);return e.join("")}function b64arrays(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array,f64=new Array;for(var e=0;e<t.length;e++)b64[e]=t.charAt(e),f64[t.charAt(e)]=e}function b64d2t(t){var e=new Array,n=0,r=t.length;for(r%3==1&&(t[t.length]=0,t[t.length]=0),r%3==2&&(t[t.length]=0);n<t.length;)e[e.length]=b64[t[n]>>2],e[e.length]=b64[(3&t[n])<<4|t[n+1]>>4],e[e.length]=b64[(15&t[n+1])<<2|t[n+2]>>6],e[e.length]=b64[63&t[n+2]],n+=3;r%3==1&&(e[e.length-1]=e[e.length-2]="="),r%3==2&&(e[e.length-1]="=");var i=e.join("");return i}function b64t2d(t){var e=new Array,n=0;for(t=t.replace(/\n|\r/g,""),t=t.replace(/=/g,"");n<t.length;)e[e.length]=f64[t.charAt(n)]<<2|f64[t.charAt(n+1)]>>4,e[e.length]=(15&f64[t.charAt(n+1)])<<4|f64[t.charAt(n+2)]>>2,e[e.length]=(3&f64[t.charAt(n+2)])<<6|f64[t.charAt(n+3)],n+=4;return t.length%4==2&&(e=e.slice(0,e.length-2)),t.length%4==3&&(e=e.slice(0,e.length-1)),e}function STANZA_ERROR(t,e,n){return window==this?new STANZA_ERROR(t,e,n):(this.code=t,this.type=e,void(this.cond=n))}function JSJaCCookieException(t){this.message=t,this.name="CookieException"}function JSJaCCookie(t,e,n,r,i){return window==this?new JSJaCCookie(t,e,n,r,i):(this.name=t,this.value=e,this.secs=n,this.domain=r,this.path=i,this.write=function(){var t;if(this.secs){var e=new Date;e.setTime(e.getTime()+1e3*this.secs),t="; expires="+e.toGMTString()}else t="";var n=this.domain?"; domain="+this.domain:"",r=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+t+n+r},this.erase=function(){var t=new JSJaCCookie(this.getName(),"",(-1));t.write()},this.getName=function(){return this.name},this.setName=function(t){return this.name=t,this},this.getValue=function(){return this.value},this.setValue=function(t){return this.value=t,this},this.setDomain=function(t){return this.domain=t,this},void(this.setPath=function(t){return this.path=t,this}))}function JSJaCJSON(){}function JSJaCJIDInvalidException(t){this.message=t,this.name="JSJaCJIDInvalidException"}function JSJaCJID(t){this._node="",this._domain="",this._resource="","string"==typeof t?(t.indexOf("@")!=-1&&(this.setNode(t.substring(0,t.indexOf("@"))),t=t.substring(t.indexOf("@")+1)),t.indexOf("/")!=-1&&(this.setResource(t.substring(t.indexOf("/")+1)),t=t.substring(0,t.indexOf("/"))),this.setDomain(t)):(this.setNode(t.node),this.setDomain(t.domain),this.setResource(t.resource))}function JSJaCPacket(t){this.name=t,"undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?this.doc=XmlDocument.create(t,NS_CLIENT):this.doc=XmlDocument.create(t,"")}function JSJaCPresence(){this.base=JSJaCPacket,this.base("presence")}function JSJaCIQ(){this.base=JSJaCPacket,this.base("iq")}function JSJaCMessage(){this.base=JSJaCPacket,this.base("message")}function JSJaCError(t,e,n){var r=XmlDocument.create("error","jsjac");return r.documentElement.setAttribute("code",t),r.documentElement.setAttribute("type",e),n&&r.documentElement.appendChild(r.createElement(n)).setAttribute("xmlns",NS_STANZAS),r.documentElement}function JSJaCKeys(t,e){var n=Math.random();if(this._k=[],this._k[0]=n.toString(),e?this.oDbg=e:(this.oDbg={},this.oDbg.log=function(){}),t)for(var r=1;r<JSJAC_NKEYS;r++)this._k[r]=t(this._k[r-1]),e.log(r+": "+this._k[r],4);this._indexAt=JSJAC_NKEYS-1,this.getKey=function(){return this._k[this._indexAt--]},this.lastKey=function(){return 0===this._indexAt},this.size=function(){return this._k.length},this._getSuspendVars=function(){return"_k,_indexAt".split(",")}}function JSJaCConnection(t){t&&t.httpbase&&(this._httpbase=t.httpbase),t&&t.oDbg&&t.oDbg.log?this.oDbg=t.oDbg:this.oDbg={log:function(){}},t&&t.timerval?this.setPollInterval(t.timerval):this.setPollInterval(JSJAC_TIMERVAL),t&&t.cookie_prefix?this._cookie_prefix=t.cookie_prefix:this._cookie_prefix="",this._connected=!1,this._events=[],this._keys=null,this._ID=0,this._inQ=[],this._pQueue=[],this._regIDs=[],this._req=[],this._status="intialized",this._errcnt=0,this._inactivity=JSJAC_INACTIVITY,this._sendRawCallbacks=[]}function JSJaCHttpPollingConnection(t){this.base=JSJaCConnection,this.base(t),JSJACPACKET_USE_XMLNS=!1}function JSJaCHttpBindingConnection(t){this.base=JSJaCConnection,this.base(t),this._hold=JSJACHBC_MAX_HOLD,this._inactivity=0,this._last_requests={},this._last_rid=0,this._min_polling=0,this._pause=0,this._wait=t.wait||JSJACHBC_MAX_WAIT}function JSJaCConsoleLogger(t){this.level=t||4,this.start=function(){},this.log=function(t,e){if(e=e||0,!(e>this.level)&&"undefined"!=typeof console)try{switch(e){case 0:console.warn(t);break;case 1:console.error(t);break;case 2:console.info(t);break;case 4:console.debug(t);break;default:console.log(t)}}catch(n){try{console.log(t)}catch(r){}}},this.setLevel=function(t){return this.level=t,this},this.getLevel=function(){return this.level}}function JSJaCWebSocketConnection(t){this.base=JSJaCConnection,this.base(t),this._ws=null,this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}XmlHttp.create=function(){try{if(window.XMLHttpRequest){var t=new XMLHttpRequest;return null===t.readyState&&(t.readyState=1,t.addEventListener("load",function(){t.readyState=4,"function"==typeof t.onreadystatechange&&t.onreadystatechange()},!1)),t}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(e){}throw new Error("Your browser does not support XmlHttp objects")},XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var t,e=["MSXML2","Microsoft","MSXML","MSXML3"],n=0;n<e.length;n++)try{return t=new ActiveXObject(e[n]+".XmlHttp"),XmlHttp.prefix=e[n]}catch(r){}throw new Error("Could not find an installed XML parser")},XmlDocument.create=function(t,e){t=t||"foo",e=e||"";try{var n;if(document.implementation&&document.implementation.createDocument?(n=document.implementation.createDocument(e,t,null),null===n.readyState&&(n.readyState=1,n.addEventListener("load",function(){n.readyState=4,"function"==typeof n.onreadystatechange&&n.onreadystatechange()},!1))):window.ActiveXObject&&(n=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument")),!n.documentElement||n.documentElement.tagName!=t||n.documentElement.namespaceURI&&n.documentElement.namespaceURI!=e)try{""!==e?n.appendChild(n.createElement(t)).setAttribute("xmlns",e):n.appendChild(n.createElement(t))}catch(r){n=document.implementation.createDocument(e,t,null),null===n.documentElement&&n.appendChild(n.createElement(t)),""!==e&&n.documentElement.getAttribute("xmlns")!=e&&n.documentElement.setAttribute("xmlns",e)}return n}catch(i){}throw new Error("Your browser does not support XmlDocument objects")},XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var t,e=["MSXML2","Microsoft","MSXML","MSXML3"],n=0;n<e.length;n++)try{return t=new ActiveXObject(e[n]+".DomDocument"),XmlDocument.prefix=e[n]}catch(r){}throw new Error("Could not find an installed XML parser")},"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(t){for(var e=(new DOMParser).parseFromString(t,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var n=0;n<e.childNodes.length;n++)this.appendChild(this.importNode(e.childNodes[n],!0))}),window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)})),String.prototype.htmlEnc=function(){if(!this)return this;var t=this.replace(/&/g,"&amp;");return t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/\"/g,"&quot;"),t=t.replace(/\n/g,"<br />")},String.prototype.revertHtmlEnc=function(){if(!this)return this;var t=this.replace(/&amp;/gi,"&");return t=t.replace(/&lt;/gi,"<"),t=t.replace(/&gt;/gi,">"),t=t.replace(/&quot;/gi,'"'),t=t.replace(/<br( )?(\/)?>/gi,"\n")},Date.jab2date=function(t){var e=new Date(Date.UTC(t.substr(0,4),t.substr(5,2)-1,t.substr(8,2),t.substr(11,2),t.substr(14,2),t.substr(17,2)));if("Z"!=t.substr(t.length-6,1)){var n=new Date;n.setTime(0),n.setUTCHours(t.substr(t.length-5,2)),n.setUTCMinutes(t.substr(t.length-2,2)),"+"==t.substr(t.length-6,1)?e.setTime(e.getTime()-n.getTime()):"-"==t.substr(t.length-6,1)&&e.setTime(e.getTime()+n.getTime())}return e},Date.hrTime=function(t){return Date.jab2date(t).toLocaleString()},Date.prototype.jabberDate=function(){var t=function(t){return t<10?"0"+t:t},e=this.getUTCFullYear()+"-";return e+=t(this.getUTCMonth()+1)+"-",e+=t(this.getUTCDate())+"T",e+=t(this.getUTCHours())+":",e+=t(this.getUTCMinutes())+":",e+=t(this.getUTCSeconds())+"Z"},Number.max=function(t,e){return t>e?t:e},Number.min=function(t,e){return t<e?t:e};var hexcase=0,b64pad="=";"undefined"!=typeof atob&&"undefined"!=typeof btoa||b64arrays(),"undefined"==typeof atob?(b64decode=function(t){return utf8d2t(b64t2d(t))},b64decode_bin=function(t){for(var e=b64t2d(t),n="",r=0;r<e.length;r++)n+=String.fromCharCode(e[r]);return n}):(b64decode=function(t){return decodeURIComponent(escape(atob(t)))},b64decode_bin=atob),"undefined"==typeof btoa?b64encode=function(t){return b64d2t(utf8t2d(t))}:b64encode=function(t){return btoa(unescape(encodeURIComponent(t)))},JSJAC_HAVEKEYS=!0,JSJAC_NKEYS=16,JSJAC_INACTIVITY=300,JSJAC_ERR_COUNT=10,JSJAC_ALLOW_PLAIN=!0,JSJAC_ALLOW_SCRAM=!1,JSJAC_CHECKQUEUEINTERVAL=100,JSJAC_CHECKINQUEUEINTERVAL=100,JSJAC_TIMERVAL=2e3,JSJAC_RETRYDELAY=5e3,JSJAC_REGID_TIMEOUT=2e4,JSJACHBC_MAX_HOLD=1,JSJACHBC_MAX_WAIT=300,JSJACHBC_BOSH_VERSION="1.10",JSJACHBC_USE_BOSH_VER=!0,JSJACHBC_MAXPAUSE=120;var NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_VCARD_UPDATE="vcard-temp:x:update",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_BOOKSMARKS="storage:bookmarks",NS_FORWARD_0="urn:xmpp:forward:0",NS_CARBONS_2="urn:xmpp:carbons:2",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_ERRORS="http://jabber.org/protocol/pubsub#errors",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",NS_CAPS="http://jabber.org/protocol/caps",NS_STREAM="http://etherx.jabber.org/streams",NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS="http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress",ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");JSJaCCookie.read=function(t){for(var e=t+"=",n=document.cookie.split(";"),r=0;r<n.length;r++){for(var i=n[r];" "==i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(e))return new JSJaCCookie(t,JSJaCCookie._unescape(i.substring(e.length,i.length)))}throw new JSJaCCookieException("Cookie not found")},JSJaCCookie.get=function(t){return JSJaCCookie.read(t).getValue()},JSJaCCookie.remove=function(t){JSJaCCookie.read(t).erase()},JSJaCCookie._escape=function(t){return t.replace(/;/g,"%3AB")},JSJaCCookie._unescape=function(t){return t.replace(/%3AB/g,";")},JSJaCJSON.toString=function(t){var e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},n={array:function(t){var e,r,i,s,o=["["],a=t.length;for(i=0;i<a;i+=1)if(s=t[i],r=n[typeof s])try{s=r(s),"string"==typeof s&&(e&&(o[o.length]=","),o[o.length]=s,e=!0)}catch(h){}return o[o.length]="]",o.join("")},"boolean":function(t){return String(t)},"null":function(){return"null"},number:function(t){return isFinite(t)?String(t):"null"},object:function(t){if(t){if(t instanceof Array)return n.array(t);var e,r,i,s,o=[];o.push("{");for(i in t)if(t.hasOwnProperty(i)&&(s=t[i],r=n[typeof s]))try{s=r(s),"string"==typeof s&&(e&&(o[o.length]=","),o.push(n.string(i),":",s),e=!0)}catch(a){}return o[o.length]="}",o.join("")}return"null"},string:function(t){return/["\\\x00-\x1f]/.test(t)&&(t=t.replace(/([\x00-\x1f\\"])/g,function(t,n){var r=e[n];return r?r:(r=n.charCodeAt(),"\\u00"+Math.floor(r/16).toString(16)+(r%16).toString(16))})),'"'+t+'"'}};switch(typeof t){case"object":return n.object(t);case"array":return n.array(t)}},JSJaCJSON.parse=function(str){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+str+")")}catch(e){return!1}};var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()},JSJaCJID.prototype.getNode=function(){return this._node},JSJaCJID.prototype.getDomain=function(){return this._domain},JSJaCJID.prototype.getResource=function(){return this._resource},JSJaCJID.prototype.setNode=function(t){return JSJaCJID._checkNodeName(t),this._node=t||"",this},JSJaCJID.prototype.setDomain=function(t){if(!t||""===t)throw new JSJaCJIDInvalidException("domain name missing");return JSJaCJID._checkNodeName(t),this._domain=t,this},JSJaCJID.prototype.setResource=function(t){return this._resource=t||"",this},JSJaCJID.prototype.toString=function(){var t="";return this.getNode()&&""!==this.getNode()&&(t=this.getNode()+"@"),t+=this.getDomain(),this.getResource()&&""!==this.getResource()&&(t+="/"+this.getResource()),t},JSJaCJID.prototype.removeResource=function(){return this.setResource()},JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())},JSJaCJID.prototype.isEntity=function(t){return t="string"==typeof t?new JSJaCJID(t):t.clone(),t.removeResource(),this.clone().removeResource().toString()===t.toString()},JSJaCJID._checkNodeName=function(t){if(t&&""!==t)for(var e=0;e<JSJACJID_FORBIDDEN.length;e++)if(t.indexOf(JSJACJID_FORBIDDEN[e])!=-1)throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[e])};var JSJaCUtils={xor:function(t,e){if(!t)return e;if(!e)return t;for(var n="",r=0;r<t.length;r++)n+=String.fromCharCode(t.charCodeAt(r)^e.charCodeAt(r));return n},cnonce:function(t){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<t;r++)n+=e.charAt(Math.round(Math.random((new Date).getTime())*(e.length-1)));return n},now:function(){return Date.now&&"function"==typeof Date.now?Date.now():(new Date).getTime()}},JSJaCBuilder={buildNode:function(t,e){var n,r=arguments[4];if(arguments[2])if(JSJaCBuilder._isStringOrNumber(arguments[2])||arguments[2]instanceof Array)n=this._createElement(t,e,r),JSJaCBuilder._children(t,n,arguments[2]);else{r=arguments[2].xmlns||r,n=this._createElement(t,e,r);for(var i in arguments[2])arguments[2].hasOwnProperty(i)&&"xmlns"!=i&&n.setAttribute(i,arguments[2][i])}else n=this._createElement(t,e,r);return arguments[3]&&JSJaCBuilder._children(t,n,arguments[3],r),n},_createElement:function(t,e,n){try{if(n)return t.createElementNS(n,e)}catch(r){}var i=t.createElement(e);return n&&i.setAttribute("xmlns",n),i},_text:function(t,e){return t.createTextNode(e)},_children:function(t,e,n,r){if("object"==typeof n){for(var i in n)if(n.hasOwnProperty(i)){var s=n[i];if("object"==typeof s)if(s instanceof Array){var o=JSJaCBuilder.buildNode(t,s[0],s[1],s[2],r);e.appendChild(o)}else e.appendChild(s);else JSJaCBuilder._isStringOrNumber(s)&&e.appendChild(JSJaCBuilder._text(t,s))}}else JSJaCBuilder._isStringOrNumber(n)&&e.appendChild(JSJaCBuilder._text(t,n))},_attributes:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n+'="'+t[n].toString().htmlEnc()+'"');return e.join(" ")},_isStringOrNumber:function(t){return"string"==typeof t||"number"==typeof t}},JSJACPACKET_USE_XMLNS=!0;JSJaCPacket.prototype.pType=function(){return this.name},JSJaCPacket.prototype.getDoc=function(){return this.doc},JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null},JSJaCPacket.prototype.setTo=function(t){return t?"string"==typeof t?this.getNode().setAttribute("to",t):this.getNode().setAttribute("to",t.toString()):this.getNode().removeAttribute("to"),this},JSJaCPacket.prototype.setFrom=function(t){return t?"string"==typeof t?this.getNode().setAttribute("from",t):this.getNode().setAttribute("from",t.toString()):this.getNode().removeAttribute("from"),this},JSJaCPacket.prototype.setID=function(t){return t?this.getNode().setAttribute("id",t):this.getNode().removeAttribute("id"),this},JSJaCPacket.prototype.setType=function(t){return t?this.getNode().setAttribute("type",t):this.getNode().removeAttribute("type"),this},JSJaCPacket.prototype.setXMLLang=function(t){return t?this.getNode().setAttribute("xml:lang",t):this.getNode().removeAttribute("xml:lang"),this},JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")},JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")},JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())},JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())},JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")},JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")},JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")},JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")},JSJaCPacket.prototype.getChild=function(t,e){if(!this.getNode())return null;if(t=t||"*",e=e||"*",this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(e,t).item(0);var n=this.getNode().getElementsByTagName(t);if("*"==e)return n.item(0);for(var r=0;r<n.length;r++)if(n.item(r).namespaceURI==e||n.item(r).getAttribute("xmlns")==e)return n.item(r);return null},JSJaCPacket.prototype.getChildVal=function(t,e){var n=this.getChild(t,e),r="";if(n&&n.hasChildNodes())for(var i=0;i<n.childNodes.length;i++)n.childNodes.item(i).nodeValue&&(r+=n.childNodes.item(i).nodeValue);return r},JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())},JSJaCPacket.prototype.isError=function(){return"error"==this.getType()},JSJaCPacket.prototype.errorReply=function(t){var e=this.clone();return e.setTo(this.getFrom()),e.setFrom(),e.setType("error"),e.appendNode("error",{code:t.code,type:t.type},[[t.cond,{xmlns:NS_STANZAS}]]),e},JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var t=(new XMLSerializer).serializeToString(this.getNode());return"undefined"==typeof t&&(t=(new XMLSerializer).serializeToString(this.doc)),t}:function(){return this.getDoc().xml},JSJaCPacket.prototype._getAttribute=function(t){return this.getNode().getAttribute(t)},document.ELEMENT_NODE||(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12),JSJaCPacket.prototype._importNode=function(t,e){switch(t.nodeType){case document.ELEMENT_NODE:var n;n=this.getDoc().createElementNS?this.getDoc().createElementNS(t.namespaceURI,t.nodeName):this.getDoc().createElement(t.nodeName);var r,i;if(t.attributes&&t.attributes.length>0)for(r=0,i=t.attributes.length;r<i;r++){var s=t.attributes.item(r);("xmlns"!=s.nodeName||null===n.getAttribute("xmlns")&&!n.namespaceURI)&&(n.setAttributeNS&&s.namespaceURI?n.setAttributeNS(s.namespaceURI,s.name,s.value):n.setAttribute(s.name,s.value))}if(e&&t.childNodes&&t.childNodes.length>0)for(r=0,i=t.childNodes.length;r<i;r++)n.appendChild(this._importNode(t.childNodes.item(r),e));return n;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(t.nodeValue)}},JSJaCPacket.prototype._setChildNode=function(t,e){var n=this.getChild(t),r=this.getDoc().createTextNode(e);if(n)try{n.replaceChild(r,n.firstChild)}catch(i){}else{try{n=this.getDoc().createElementNS(this.getNode().namespaceURI,t)}catch(s){n=this.getDoc().createElement(t)}this.getNode().appendChild(n),n.appendChild(r)}return n},JSJaCPacket.prototype.buildNode=function(t){return JSJaCBuilder.buildNode(this.getDoc(),t,arguments[1],arguments[2],arguments[3])},JSJaCPacket.prototype.appendNode=function(t){return"object"==typeof t?this.getNode().appendChild(t):this.getNode().appendChild(this.buildNode(t,arguments[1],arguments[2],this.getNode().namespaceURI)),this},JSJaCPresence.prototype=new JSJaCPacket,JSJaCPresence.prototype.setStatus=function(t){return this._setChildNode("status",t),this},JSJaCPresence.prototype.setShow=function(t){
return"chat"!=t&&"away"!=t&&"xa"!=t&&"dnd"!=t||this._setChildNode("show",t),this},JSJaCPresence.prototype.setPriority=function(t){return this._setChildNode("priority",t),this},JSJaCPresence.prototype.setPresence=function(t,e,n){return t&&this.setShow(t),e&&this.setStatus(e),n&&this.setPriority(n),this},JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")},JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")},JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")},JSJaCIQ.prototype=new JSJaCPacket,JSJaCIQ.prototype.setIQ=function(t,e,n){return t&&this.setTo(t),e&&this.setType(e),n&&this.setID(n),this},JSJaCIQ.prototype.setQuery=function(t){var e;try{e=this.getDoc().createElementNS(t,"query")}catch(n){e=this.getDoc().createElement("query"),e.setAttribute("xmlns",t)}return this.getNode().appendChild(e),e},JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)},JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null},JSJaCIQ.prototype.reply=function(t){var e=this.clone();if(e.setTo(this.getFrom()),e.setFrom(),e.setType("result"),t)if("string"==typeof t)e.getChild().appendChild(e.getDoc().loadXML(t));else if(t.constructor==Array)for(var n=e.getChild(),r=0;r<t.length;r++)"string"==typeof t[r]?n.appendChild(e.getDoc().loadXML(t[r])):"object"==typeof t[r]&&n.appendChild(t[r]);else"object"==typeof t&&e.getChild().appendChild(t);return e},JSJaCMessage.prototype=new JSJaCPacket,JSJaCMessage.prototype.setBody=function(t){return this._setChildNode("body",t),this},JSJaCMessage.prototype.setSubject=function(t){return this._setChildNode("subject",t),this},JSJaCMessage.prototype.setThread=function(t){return this._setChildNode("thread",t),this},JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")},JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")},JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")},JSJaCPacket.wrapNode=function(t){var e=null;switch(t.nodeName.toLowerCase()){case"presence":e=new JSJaCPresence;break;case"message":e=new JSJaCMessage;break;case"iq":e=new JSJaCIQ}return e&&e.getDoc().replaceChild(e._importNode(t,!0),e.getNode()),e},JSJaCConnection.prototype.connect=function(t){this._setStatus("connecting"),this.domain=t.domain||"localhost",this.username=t.username,this.resource=t.resource,this.pass=t.password||t.pass,this.authzid=t.authzid||"",this.register=t.register,this.authhost=t.authhost||t.host||t.domain,this.authtype=t.authtype||"sasl",t.xmllang&&""!==t.xmllang?this._xmllang=t.xmllang:this._xmllang="en",t.allow_plain?this._allow_plain=t.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,t.allow_scram?this._allow_scram=t.allow_scram:this._allow_scram=JSJAC_ALLOW_SCRAM,this.host=t.host,this.port=t.port||5222,this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._rid=Math.round(100000.5+799999.99999*Math.random());var e=this._getFreeSlot();this._req[e]=this._setupRequest(!0);var n=this._getInitialRequestString();this.oDbg.log(n,4),this._req[e].r.onreadystatechange=JSJaC.bind(function(){var t=this._req[e].r;4==t.readyState&&(this.oDbg.log("async recv: "+t.responseText,4),this._handleInitialResponse(t))},this),"undefined"!=typeof this._req[e].r.onerror&&(this._req[e].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this)),this._req[e].r.send(n)},JSJaCConnection.prototype.connected=function(){return this._connected},JSJaCConnection.prototype.disconnect=function(){if(this._setStatus("disconnecting"),this.connected()){this._connected=!1,clearInterval(this._interval),clearInterval(this._inQto),this._timeout&&clearTimeout(this._timeout);var t=this._getFreeSlot();this._req[t]=this._setupRequest(!1);var e=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+e,4);try{this._req[t].r.send(e)}catch(n){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(n){}this._handleEvent("ondisconnect")}},JSJaCConnection.prototype.getPollInterval=function(){return this._timerval},JSJaCConnection.prototype.registerHandler=function(t){t=t.toLowerCase();var e={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};return arguments.length>2&&(e.childName=arguments[1]),arguments.length>3&&(e.childNS=arguments[2]),arguments.length>4&&(e.type=arguments[3]),this._events[t]?this._events[t]=this._events[t].concat(e):this._events[t]=[e],this._events[t]=this._events[t].sort(function(t,e){var n=0,r=0;return"*"==t.type&&n++,"*"==t.childNS&&n++,"*"==t.childName&&n++,"*"==e.type&&r++,"*"==e.childNS&&r++,"*"==e.childName&&r++,n>r?1:n<r?-1:0}),this.oDbg.log("registered handler for event '"+t+"'",2),this},JSJaCConnection.prototype.unregisterHandler=function(t,e){if(t=t.toLowerCase(),!this._events[t])return this;for(var n=this._events[t],r=[],i=0;i<n.length;i++)n[i].handler!=e&&r.push(n[i]);return n.length!=r.length&&(this._events[t]=r,this.oDbg.log("unregistered handler for event '"+t+"'",2)),this},JSJaCConnection.prototype.registerIQGet=function(t,e,n){return this.registerHandler("iq",t,e,"get",n)},JSJaCConnection.prototype.registerIQSet=function(t,e,n){return this.registerHandler("iq",t,e,"set",n)},JSJaCConnection.prototype.resume=function(){try{var t=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();return this.oDbg.log("read cookie: "+t,2),JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase(),this.resumeFromData(JSJaCJSON.parse(t))}catch(e){}return!1},JSJaCConnection.prototype.resumeFromData=function(t){try{for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);if(this._keys){this._keys2=new JSJaCKeys;for(var n=this._keys2._getSuspendVars(),r=0;r<n.length;r++)this._keys2[n[r]]=this._keys[n[r]];this._keys=this._keys2}return this._connected?(this._setStatus("resuming"),this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)):this._setStatus("terminated"),this._connected===!0}catch(i){return i.message?this.oDbg.log("Resume failed: "+i.message,1):this.oDbg.log("Resume failed: "+i,1),!1}},JSJaCConnection.prototype.send=function(t,e,n){return t&&t.pType?!!this.connected()&&(e&&(t.getID()||t.setID("JSJaCID_"+this._ID++),this._registerPID(t,e,n)),this._pQueue=this._pQueue.concat(t.xml()),this._handleEvent(t.pType()+"_out",t),this._handleEvent("packet_out",t),!0):(this.oDbg.log("no packet: "+t,1),!1)},JSJaCConnection.prototype.sendIQ=function(t,e,n){if(!t||"iq"!=t.pType())return!1;e=e||{};var r=e.error_handler||JSJaC.bind(function(t){this.oDbg.log(t.xml(),1)},this),i=e.result_handler||JSJaC.bind(function(t){this.oDbg.log(t.xml(),2)},this),s=function(t,e){switch(t.getType()){case"error":r(t);break;case"result":i(t,e)}};return this.send(t,s,n)},JSJaCConnection.prototype.setPollInterval=function(t){return t&&!isNaN(t)&&(this._timerval=t),this._timerval},JSJaCConnection.prototype.status=function(){return this._status},JSJaCConnection.prototype.suspend=function(){var t=this.suspendToData();try{var e=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(t));this.oDbg.log("writing cookie: "+e.getValue()+"\n(length:"+e.getValue().length+")",2),e.write();var n=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return e.getValue()==n||(this.oDbg.log("Suspend failed writing cookie.\nread: "+n,1),e.erase(),!1)}catch(r){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+r.message,1)}return!1},JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._suspend();var t="_connected,_keys,_ID,_xmllang,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling".split(",");t=t.concat(this._getSuspendVars());for(var e={},n=0;n<t.length;n++)if(this[t[n]]){var r={};if(this[t[n]]._getSuspendVars)for(var i=this[t[n]]._getSuspendVars(),s=0;s<i.length;s++)r[i[s]]=this[t[n]][i[s]];else r=this[t[n]];e[t[n]]=r}return this._connected=!1,this._setStatus("suspending"),e},JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout),clearInterval(this._inQto),clearInterval(this._interval),this._connected=!1,this._setStatus("aborted"),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))},JSJaCConnection.prototype._checkInQ=function(){for(var t=0;t<this._inQ.length&&t<10;t++){var e=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);var n=JSJaCPacket.wrapNode(e);if(!n)return;this._handleEvent("packet_in",n),n.pType&&!this._handlePID(n)&&(this._handleEvent(n.pType()+"_in",n),this._handleEvent(n.pType(),n))}},JSJaCConnection.prototype._checkQueue=function(){return this._pQueue.length>0&&this._process(),!0},JSJaCConnection.prototype._doAuth=function(){return this.has_sasl&&"nonsasl"==this.authtype&&this.oDbg.log("Warning: SASL present but not used",1),!(!this._doSASLAuth()&&!this._doLegacyAuth())||(this.oDbg.log("Auth failed for authtype "+this.authtype,1),this.disconnect(),!1)},JSJaCConnection.prototype._doInBandReg=function(){if("saslanon"!=this.authtype&&"anonymous"!=this.authtype){var t=new JSJaCIQ;t.setType("set"),t.setID("reg1"),t.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]),this.send(t,this._doInBandRegDone)}},JSJaCConnection.prototype._doInBandRegDone=function(t){return t&&"error"==t.getType()?(this.oDbg.log("registration failed for "+this.username,0),void this._handleEvent("onerror",t.getChild("error"))):(this.oDbg.log(this.username+" registered succesfully",0),void this._handleEvent("onregister",t))},JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var t=new JSJaCIQ;return t.setIQ(null,"get","auth1"),t.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]),this.send(t,this._doLegacyAuth2),!0},JSJaCConnection.prototype._doLegacyAuth2=function(t){if(!t||"result"!=t.getType())return t&&"error"==t.getType()&&this._handleEvent("onerror",t.getChild("error")),void this.disconnect();var e=null!==t.getChild("digest"),n=new JSJaCIQ;n.setIQ(null,"set","auth2");var r=n.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(e)r.appendChild(n.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else{if(!this._allow_plain)return this.oDbg.log("no valid login mechanism found",1),void this.disconnect();r.appendChild(n.buildNode("password",{xmlns:NS_AUTH},this.pass))}this.send(n,this._doLegacyAuthDone)},JSJaCConnection.prototype._doLegacyAuthDone=function(t){"result"!=t.getType()?("error"==t.getType()&&this._handleEvent("onerror",t.getChild("error")),this.disconnect()):this._handleEvent("onconnect")},JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("saslanon"==this.authtype){if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}else{if(this._allow_scram&&this.mechs["SCRAM-SHA-1"]){this.oDbg.log("SASL using mechanism 'SCRAM-SHA-1'",2),this._clientFirstMessageBare="n="+this.username.replace(/=/g,"=3D").replace(/,/g,"=2C")+",r="+JSJaCUtils.cnonce(16);var t;t=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";var e=t+this._clientFirstMessageBare;return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='SCRAM-SHA-1'>"+b64encode(e)+"</auth>",this._doSASLAuthScramSha1S1)}if(this.mechs["DIGEST-MD5"])return this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",this._doSASLAuthDigestMd5S1);if(this._allow_plain&&this.mechs.PLAIN){this.oDbg.log("SASL using mechanism 'PLAIN'",2);var n=this.authzid+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;return this.oDbg.log("authenticating with '"+n+"'",2),n=b64encode(n),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+n+"</auth>",this._doSASLAuthDone)}this.oDbg.log("No SASL mechanism applied",1),this.authtype="nonsasl"}return!1},JSJaCConnection.prototype._doSASLAuthScramSha1S1=function(t){if("challenge"!=t.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var e=b64decode(t.firstChild.nodeValue);this.oDbg.log("got challenge: "+e,2);var n={},r=e.split(",");for(var i in r){var s=r[i].substring(2);n[r[i].substring(0,1)]=s}for(var o,a=str2rstr_utf8(this.pass),h=b64decode_bin(n.s)+"\0\0\0",c=parseInt(n.i,10),l=0;l<c;l++)h=rstr_hmac_sha1(a,h),o=JSJaCUtils.xor(o,h);var u;u=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";var d="c="+b64encode(u)+",r="+n.r;this._saltedPassword=o;var _=rstr_hmac_sha1(this._saltedPassword,"Client Key"),g=rstr_sha1(_);this._authMessage=this._clientFirstMessageBare+","+e+","+d;var p=rstr_hmac_sha1(g,str2rstr_utf8(this._authMessage)),m=JSJaCUtils.xor(_,p),S=d+",p="+rstr2b64(m);this.oDbg.log("response: "+S,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(S)+"</response>",this._doSASLAuthScramSha1S2)}},JSJaCConnection.prototype._doSASLAuthScramSha1S2=function(t){if("success"!=t.nodeName)this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var e=b64decode(t.firstChild.nodeValue);this.oDbg.log("got success: "+e,2);var n={},r=e.split(",");for(var i in r){var s=r[i].substring(2);n[r[i].substring(0,1)]=s}var o=rstr_hmac_sha1(this._saltedPassword,"Server Key"),a=rstr_hmac_sha1(o,str2rstr_utf8(this._authMessage)),h=b64decode_bin(n.v);a!==h?(this.oDbg.log("server auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))}},JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(t){if("challenge"!=t.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var e,n=b64decode(t.firstChild.nodeValue);if(this.oDbg.log("got challenge: "+n,2),e=n.indexOf('nonce="'),e===-1)return this.oDbg.log("no valid nonce found, aborting",1),void this.disconnect();this._nonce=n.substring(e+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),e=n.indexOf('realm="'),e!==-1&&(this._realm=n.substring(e+7),this._realm=this._realm.substring(0,this._realm.indexOf('"'))),this._realm=this._realm||this.domain,this.oDbg.log("realm: "+this._realm,2),this._digest_uri="xmpp/"+this.domain,this._cnonce=JSJaCUtils.cnonce(14),this._nc="00000001";var r=this.username+":"+this._realm+":"+this.pass,i=rstr_md5(str2rstr_utf8(r)),s=i+":"+this._nonce+":"+this._cnonce;this.authzid&&(s=s+":"+this.authzid);var o=rstr2hex(rstr_md5(s)),a="AUTHENTICATE:"+this._digest_uri,h=hex_md5(a),c=hex_md5(o+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+h),l='username="'+this.username+'",realm="'+this._realm+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc='+this._nc+',qop=auth,digest-uri="'+this._digest_uri+'",response='+c+",charset=utf-8";this.authzid&&(l='authzid="'+this.authzid+'",'+l),this.oDbg.log("response: "+l,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(l)+"</response>",this._doSASLAuthDigestMd5S2)}},JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(t){if("failure"==t.nodeName)return t.xml?this.oDbg.log("auth error: "+t.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),void this.disconnect();var e=b64decode(t.firstChild.nodeValue);this.oDbg.log("response: "+e,2);var n=e.substring(e.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+n,2);var r=this.username+":"+this._realm+":"+this.pass,i=rstr_md5(str2rstr_utf8(r)),s=i+":"+this._nonce+":"+this._cnonce;this.authzid&&(s=s+":"+this.authzid);var o=rstr2hex(rstr_md5(s)),a=":"+this._digest_uri,h=hex_md5(a),c=hex_md5(o+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+h);return this.oDbg.log("rsptest: "+c,2),c!=n?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),void this.disconnect()):void("success"==t.nodeName?this._doStreamBind():this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone))},JSJaCConnection.prototype._doSASLAuthDone=function(t){"success"!=t.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._doStreamBind()},JSJaCConnection.prototype._doStreamBind=function(){var t=new JSJaCIQ;t.setIQ(null,"set","bind_1"),t.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]),this.oDbg.log(t.xml()),this.send(t,this._doXMPPSess)},JSJaCConnection.prototype._doXMPPSess=function(t){return"result"!=t.getType()||"error"==t.getType()?(this.disconnect(),void("error"==t.getType()&&this._handleEvent("onerror",t.getChild("error")))):(this.fulljid=t.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),t=new JSJaCIQ,t.setIQ(null,"set","sess_1"),t.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(t.xml()),void this.send(t,this._doXMPPSessDone))},JSJaCConnection.prototype._doXMPPSessDone=function(t){return"result"!=t.getType()||"error"==t.getType()?(this.disconnect(),void("error"==t.getType()&&this._handleEvent("onerror",t.getChild("error")))):void this._handleEvent("onconnect")},JSJaCConnection.prototype._handleEvent=function(t,e){if(t=t.toLowerCase(),this.oDbg.log("incoming event '"+t+"'",3),this._events[t]){this.oDbg.log("handling event '"+t+"'",2);for(var n=0;n<this._events[t].length;n++){var r=this._events[t][n];if("function"==typeof r.handler)if(e){if(e.pType){if(!e.getNode().hasChildNodes()&&"*"!=r.childName||e.getNode().hasChildNodes()&&!e.getChild(r.childName,r.childNS))continue;if("*"!=r.type&&e.getType()!=r.type)continue;this.oDbg.log(r.childName+"/"+r.childNS+"/"+r.type+" => match for handler "+r.handler,3)}if(r.handler(e))break}else if(r.handler())break}}},JSJaCConnection.prototype._handlePID=function(t){if(!t.getID())return!1;var e=t.getFrom()||this.jid;t.getFrom()==this.domain&&(e=this.jid);var n=t.getID();if(this._regIDs[e]&&this._regIDs[e][n]){this.oDbg.log("handling id "+n,3);var r=this._regIDs[e][n];return r.cb.call(this,t,r.arg)!==!1&&(delete this._regIDs[e][n],!0)}return this.oDbg.log("not handling id '"+n+"' from jid "+e,1),!1},JSJaCConnection.prototype._handleResponse=function(t){var e=this._parseResponse(t);if(e)for(var n=0;n<e.childNodes.length;n++)if(this._sendRawCallbacks.length){var r=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length),r.fn.call(this,e.childNodes.item(n),r.arg)}else this._inQ=this._inQ.concat(e.childNodes.item(n))},JSJaCConnection.prototype._parseStreamFeatures=function(t){if(!t)return this.oDbg.log("nothing to parse ... aborting",1),!1;var e,n;if(t.getElementsByTagNameNS)e=t.getElementsByTagNameNS(NS_STREAM,"error").item(0);else{var r=t.getElementsByTagName("error");for(n=0;n<r.length;n++)if(r.item(n).namespaceURI==NS_STREAM||r.item(n).getAttribute("xmlns")==NS_STREAM){e=r.item(n);break}}if(e)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};var i=t.getElementsByTagName("mechanisms");if(!i.length)return!1;for(this.has_sasl=!1,n=0;n<i.length;n++)if(i.item(n).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;for(var s=i.item(n).getElementsByTagName("mechanism"),o=0;o<s.length;o++)this.mechs[s.item(o).firstChild.nodeValue]=!0;break}return this.has_sasl?(this.oDbg.log("SASL detected",2),!0):(this.oDbg.log("No support for SASL detected",2),!0)},JSJaCConnection.prototype._process=function(t){if(!this.connected())return this.oDbg.log("Connection lost ...",1),void(this._interval&&clearInterval(this._interval));this.setPollInterval(t),this._timeout&&clearTimeout(this._timeout);var e=this._getFreeSlot();if(!(e<0)){if("undefined"!=typeof this._req[e]&&"undefined"!=typeof this._req[e].r&&4!=this._req[e].r.readyState)return void this.oDbg.log("Slot "+e+" is not ready");if(!this.isPolling()&&0===this._pQueue.length&&this._req[(e+1)%2]&&4!=this._req[(e+1)%2].r.readyState)return void this.oDbg.log("all slots busy, standby ...",2);this.isPolling()||this.oDbg.log("Found working slot at "+e,2),this._req[e]=this._setupRequest(!0),this._req[e].r.onreadystatechange=JSJaC.bind(function(){this.connected()&&4==this._req[e].r.readyState&&(this.oDbg.log("async recv: "+this._req[e].r.responseText,4),this._handleResponse(this._req[e]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},this);try{this._req[e].r.onerror=JSJaC.bind(function(){if(this.connected()){if(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT)return void this._abort();this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY)}},this)}catch(n){}var r=this._getRequestString();"undefined"!=typeof this._rid&&(this._req[e].rid=this._rid),this.oDbg.log("sending: "+r,4),this._req[e].r.send(r)}},JSJaCConnection.prototype._registerPID=function(t,e,n){this.oDbg.log("registering id for packet "+t.xml(),3);var r=t.getID();if(!r)return this.oDbg.log("id missing",1),!1;if("function"!=typeof e)return this.oDbg.log("callback is not a function",1),!1;var i=t.getTo()||this.jid;return t.getTo()==this.domain&&(i=this.jid),this._regIDs[i]||(this._regIDs[i]={}),null!=this._regIDs[i][r]?(this.oDbg.log("id already registered: "+r,1),!1):(this._regIDs[i][r]={cb:e,arg:n,ts:JSJaCUtils.now()},this.oDbg.log("registered id "+r,3),this._cleanupRegisteredPIDs(),!0)},JSJaCConnection.prototype._cleanupRegisteredPIDs=function(){var t=Date.now();for(var e in this._regIDs)if(this._regIDs.hasOwnProperty(e))for(var n in this._regIDs[e])this._regIDs[e].hasOwnProperty(n)&&this._regIDs[e][n].ts+JSJAC_REGID_TIMEOUT<t&&(this.oDbg.log("deleting registered id '"+n+"' due to timeout",1),delete this._regIDs[e][n])},JSJaCConnection.prototype._prepSendEmpty=function(t,e){return function(){e._sendEmpty(JSJaC.bind(t,e))}},JSJaCConnection.prototype._sendEmpty=function(t){var e=this._getFreeSlot();this._req[e]=this._setupRequest(!0),this._req[e].r.onreadystatechange=JSJaC.bind(function(){4==this._req[e].r.readyState&&(this.oDbg.log("async recv: "+this._req[e].r.responseText,4),t(this._req[e].r))},this),"undefined"!=typeof this._req[e].r.onerror&&(this._req[e].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));var n=this._getRequestString();this.oDbg.log("sending: "+n,4),this._req[e].r.send(n)},JSJaCConnection.prototype._sendRaw=function(t,e,n){return e&&this._sendRawCallbacks.push({fn:e,arg:n}),this._pQueue.push(t),this._process(),!0},JSJaCConnection.prototype._setStatus=function(t){t&&""!==t&&t!=this._status&&(this._status=t,this._handleEvent("onstatuschanged",t),this._handleEvent("status_changed",t))},JSJaCHttpPollingConnection.prototype=new JSJaCConnection,JSJaCHttpPollingConnection.prototype.isPolling=function(){return!0},JSJaCHttpPollingConnection.prototype._getFreeSlot=function(){return"undefined"==typeof this._req[0]||"undefined"==typeof this._req[0].r||4==this._req[0].r.readyState?0:-1},JSJaCHttpPollingConnection.prototype._getInitialRequestString=function(){var t="0";if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(b64_sha1,this.oDbg);var e=this._keys.getKey();t+=";"+e}var n=this.domain;return this.authhost&&(n=this.authhost),t+=",<stream:stream to='"+n+"' xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams'","sasl"!=this.authtype&&"saslanon"!=this.authtype||(t+=" version='1.0'"),t+=">"},JSJaCHttpPollingConnection.prototype._getRequestString=function(t,e){var n=this._sid;for(JSJAC_HAVEKEYS&&(n+=";"+this._keys.getKey(),this._keys.lastKey()&&(this._keys=new JSJaCKeys(b64_sha1,this.oDbg),n+=";"+this._keys.getKey())),n+=",",t&&(n+=t);this._pQueue.length;)n+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length);return e&&(n+="</stream:stream>"),n},JSJaCHttpPollingConnection.prototype._getStreamID=function(){if(""===this._req[0].r.responseText)return this.oDbg.log("waiting for stream id",2),void(this._timeout=setTimeout(JSJaC.bind(this._sendEmpty,this),1e3));this.oDbg.log(this._req[0].r.responseText,4),this._req[0].r.responseText.match(/id=[\'\"]([^\'\"]+)[\'\"]/)&&(this.streamid=RegExp.$1),this.oDbg.log("got streamid: "+this.streamid,2);var t;try{var e=this._req[0].r.responseText;if(e.match(/<\/stream:stream>\s*$/)||(e+="</stream:stream>"),t=XmlDocument.create("doc"),t.loadXML(e),!this._parseStreamFeatures(t))return void(this.authtype="nonsasl")}catch(n){this.oDbg.log("loadXML: "+n.toString(),1)}this._connected=!0,this.register?this._doInBandReg():this._doAuth(),this._process(this._timerval)},JSJaCHttpPollingConnection.prototype._getSuspendVars=function(){return[]},JSJaCHttpPollingConnection.prototype._handleInitialResponse=function(){this.oDbg.log(this._req[0].r.getAllResponseHeaders(),4);var t=this._req[0].r.getResponseHeader("Set-Cookie");t=t.split(";");for(var e=0;e<t.length;e++){var n=t[e].split("=");"ID"==n[0]&&(this._sid=n[1])}this.oDbg.log("got sid: "+this._sid,2),this._connected=!0,this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._getStreamID()},JSJaCHttpPollingConnection.prototype._parseResponse=function(t){var e=t.r;if(!this.connected())return null;if(200!=e.status)return this.oDbg.log("invalid response ("+e.status+"):"+e.responseText+"\n"+e.getAllResponseHeaders(),1),this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),null;this.oDbg.log(e.getAllResponseHeaders(),4);var n,r=e.getResponseHeader("Set-Cookie");if(null===r)n="-1:0";else{r=r.split(";");for(var i=0;i<r.length;i++){var s=r[i].split("=");"ID"==s[0]&&(n=s[1])}}if("undefined"!=typeof n&&n.indexOf(":0")!=-1){switch(n.substring(0,n.indexOf(":0"))){case"0":this.oDbg.log("invalid response:"+e.responseText,1);break;case"-1":this.oDbg.log("Internal Server Error",1);break;case"-2":this.oDbg.log("Bad Request",1);break;case"-3":this.oDbg.log("Key Sequence Error",1)}return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}if(!e.responseText)return null;try{var o=e.responseText.replace(/<\?xml.+\?>/,"");o.match(/<stream:stream/)&&(o+="</stream:stream>");var a=JSJaCHttpPollingConnection._parseTree("<body>"+o+"</body>");return a&&"parsererror"!=a.tagName?a:(this.oDbg.log("parsererror",1),a=JSJaCHttpPollingConnection._parseTree("<stream:stream xmlns:stream='http://etherx.jabber.org/streams'>"+e.responseText),a&&"parsererror"!=a.tagName?(this.oDbg.log("stream closed",1),a.getElementsByTagName("conflict").length>0&&this._setStatus("session-terminate-conflict"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this.oDbg.log("parsererror:"+a,1),a)}catch(h){this.oDbg.log("parse error:"+h.message,1)}return null},JSJaCHttpPollingConnection.prototype._reInitStream=function(t){var e=this.authhost?this.authhost:this.domain;this._sendRaw("<stream:stream xmlns:stream='http://etherx.jabber.org/streams' xmlns='jabber:client' to='"+e+"' version='1.0'>",t)},JSJaCHttpPollingConnection.prototype._repeat=function(){this._resume()},JSJaCHttpPollingConnection.prototype._resume=function(){this._process(this._timerval)},JSJaCHttpPollingConnection.prototype._setupRequest=function(t){var e=XmlHttp.create();try{e.open("POST",this._httpbase,t),e.overrideMimeType&&e.overrideMimeType("text/plain; charset=utf-8"),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(n){this.oDbg.log(n,1)}var r={};return r.r=e,r},JSJaCHttpPollingConnection.prototype._suspend=function(){},JSJaCHttpPollingConnection._parseTree=function(t){try{var e=XmlDocument.create("body","foo");if("undefined"!=typeof e.loadXML)return e.loadXML(t),e.documentElement;if(window.DOMParser)return(new DOMParser).parseFromString(t,"text/xml").documentElement}catch(n){}return null},JSJaCHttpBindingConnection.prototype=new JSJaCConnection,JSJaCHttpBindingConnection.prototype.inherit=function(t){if(t.jid){var e=new JSJaCJID(t.jid);this.domain=e.getDomain(),this.username=e.getNode(),this.resource=e.getResource()}else this.domain=t.domain||"localhost",this.username=t.username,this.resource=t.resource;this._sid=t.sid,this._rid=t.rid,this._min_polling=t.polling,this._inactivity=t.inactivity,this._setHold(t.requests-1),this.setPollInterval(this._timerval),t.wait&&(this._wait=t.wait),this._connected=!0,this._handleEvent("onconnect"),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())},JSJaCHttpBindingConnection.prototype.setPollInterval=function(t){return t&&!isNaN(t)&&(this.isPolling()?this._min_polling&&t<1e3*this._min_polling?this._timerval=1e3*this._min_polling:this._inactivity&&t>1e3*this._inactivity?this._timerval=1e3*this._inactivity:this._timerval=t:this._timerval=100),this._timerval},JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0===this._hold},JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var t=0;t<this._hold+1;t++)if("undefined"==typeof this._req[t]||"undefined"==typeof this._req[t].r||4==this._req[t].r.readyState)return t;return-1},JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold},JSJaCHttpBindingConnection.prototype._getRequestString=function(t,e){t=t||"";var n="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])n=this._last_requests[this._rid].xml;else{for(var r="";this._pQueue.length;){var i=this._pQueue[0];r+=i,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}n="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind'",JSJAC_HAVEKEYS&&(n+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),n+=" newkey='"+this._keys.getKey()+"'")),e?n+=" type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(n+=" xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1),n+=""!==r||""!==t?">"+t+r+"</body>":"/>",this._last_requests[this._rid]={},
this._last_requests[this._rid].xml=n,this._last_rid=this._rid;for(var s in this._last_requests)this._last_requests.hasOwnProperty(s)&&s<this._rid-this._hold&&delete this._last_requests[s]}return n},JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var t="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";if(this.host&&this.port&&(t+=" route='xmpp:"+this.host+":"+this.port+"'"),JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var e=this._keys.getKey();t+=" newkey='"+e+"'"}return t+=" xml:lang='"+this._xmllang+"'",JSJACHBC_USE_BOSH_VER&&(t+=" ver='"+JSJACHBC_BOSH_VERSION+"'",t+=" xmlns:xmpp='urn:xmpp:xbosh'","sasl"!=this.authtype&&"saslanon"!=this.authtype||(t+=" xmpp:version='1.0'")),t+="/>"},JSJaCHttpBindingConnection.prototype._getStreamID=function(t){if(this.oDbg.log(t.responseText,4),!t.responseXML||!t.responseXML.documentElement)return void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var e=t.responseXML.documentElement;return"terminate"==e.getAttribute("type")?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(e.getAttribute("authid")&&(this.streamid=e.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(e)?(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),void(this.register?this._doInBandReg():this._doAuth())):void this._sendEmpty(JSJaC.bind(this._getStreamID,this)))},JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host,port,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause".split(",")},JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(t){try{this.oDbg.log(t.getAllResponseHeaders(),4),this.oDbg.log(t.responseText,4)}catch(e){this.oDbg.log("No response",4)}if(200!=t.status||!t.responseXML)return this.oDbg.log("initial response broken (status: "+t.status+")",1),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var n=t.responseXML.documentElement;return n&&"body"==n.tagName&&n.namespaceURI==NS_BOSH?"terminate"==n.getAttribute("type")?(this.oDbg.log("invalid response:\n"+t.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))):(this._sid=n.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),n.getAttribute("polling")&&(this._min_polling=n.getAttribute("polling")),n.getAttribute("inactivity")&&(this._inactivity=n.getAttribute("inactivity")),n.getAttribute("requests")&&this._setHold(n.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),n.getAttribute("ver")&&(this._bosh_version=n.getAttribute("ver")),n.getAttribute("maxpause")&&(this._pause=Number.min(n.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),void this._getStreamID(t)):(this.oDbg.log("no body element or incorrect body in initial response",1),void this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error")))},JSJaCHttpBindingConnection.prototype._parseResponse=function(t){if(!this.connected()||!t)return null;var e=t.r;try{if(404==e.status||403==e.status)return this._abort(),null;if(200!=e.status||!e.responseXML){this._errcnt++;var n="invalid response ("+e.status+"):\n"+e.getAllResponseHeaders()+"\n"+e.responseText;return e.responseXML||(n+="\nResponse failed to parse!"),this.oDbg.log(n,1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),null):(this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null)}}catch(r){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}var i=e.responseXML.documentElement;if(!i||"body"!=i.tagName||i.namespaceURI!=NS_BOSH)return this.oDbg.log("invalid response:\n"+e.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._setStatus("internal_server_error"),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),null;if("undefined"!=typeof t.rid&&this._last_requests[t.rid]){if(this._last_requests[t.rid].handled)return this.oDbg.log("already handled "+t.rid,2),null;this._last_requests[t.rid].handled=!0}if("terminate"==i.getAttribute("type")){var s=i.getAttribute("condition");this.oDbg.log("session terminated:\n"+e.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(r){}this._connected=!1,"remote-stream-error"==s&&i.getElementsByTagName("conflict").length>0?this._setStatus("session-terminate-conflict"):this._setStatus("terminated"),null===s&&(s="session-terminate"),this._handleEvent("onerror",JSJaCError("503","cancel",s)),this.oDbg.log("Aborting remaining connections",4);for(var o=0;o<this._hold+1;o++)try{this._req[o]&&this._req[o]!=t&&this._req[o].r.abort()}catch(r){this.oDbg.log(r,1)}return this.oDbg.log("parseResponse done with terminating",3),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return this._errcnt=0,e.responseXML.documentElement},JSJaCHttpBindingConnection.prototype._reInitStream=function(t){this._reinit=!0,this._sendEmpty(this._prepReInitStreamWait(t))},JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(t){return JSJaC.bind(function(e){this._reInitStreamWait(e,t)},this)},JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(t,e){this.oDbg.log("checking for stream features");var n,r,i=t.responseXML.documentElement;if(this.oDbg.log(i),i.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),n=i.getElementsByTagNameNS(NS_STREAM,"features").item(0),n&&(r=n.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var s,o,a=i.getElementsByTagName("stream:features");for(s=0,o=a.length;s<o;s++)if(a.item(s).namespaceURI==NS_STREAM||a.item(s).getAttribute("xmlns")==NS_STREAM){n=a.item(s);break}if(n)for(r=n.getElementsByTagName("bind"),s=0,o=r.length;s<o;s++)if(r.item(s).namespaceURI==NS_BIND||r.item(s).getAttribute("xmlns")==NS_BIND){r=r.item(s);break}}this.oDbg.log(n),this.oDbg.log(r),n?r?e():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(e))},JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1),this._process()},JSJaCHttpBindingConnection.prototype._resume=function(){0===this._pause?this._repeat():this._process()},JSJaCHttpBindingConnection.prototype._setHold=function(t){return!t||isNaN(t)||t<0?t=0:t>JSJACHBC_MAX_HOLD&&(t=JSJACHBC_MAX_HOLD),this._hold=t,this._hold},JSJaCHttpBindingConnection.prototype._setupRequest=function(t){var e={},n=XmlHttp.create();try{n.open("POST",this._httpbase,t),n.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(r){this.oDbg.log(r,1)}return e.r=n,this._rid++,e.rid=this._rid,e},JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!==this._pause){var t=this._getFreeSlot();this._req[t]=this._setupRequest(!1);var e="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";for(JSJAC_HAVEKEYS&&(e+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),e+=" newkey='"+this._keys.getKey()+"'")),e+=">";this._pQueue.length;){var n=this._pQueue[0];e+=n,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}e+="</body>",this.oDbg.log("Disconnecting: "+e,4),this._req[t].r.send(e)}},JSJaCWebSocketConnection.prototype=new JSJaCConnection,JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)},JSJaCWebSocketConnection.prototype.connect=function(t){return this._setStatus("connecting"),this.domain=t.domain||"localhost",this.username=t.username,this.resource=t.resource,this.pass=t.password||t.pass,this.authzid=t.authzid||"",this.register=t.register,this.authhost=t.authhost||this.domain,this.authtype=t.authtype||"sasl",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,t.allow_plain?this._allow_plain=t.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,t.allow_scram?this._allow_scram=t.allow_scram:this._allow_scram=JSJAC_ALLOW_SCRAM,t.xmllang&&""!==t.xmllang?this._xmllang=t.xmllang:this._xmllang="en","undefined"==typeof WebSocket?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),void(this._ws.onopen=JSJaC.bind(this._onopen,this)))},JSJaCWebSocketConnection.prototype._onopen=function(){var t=this._getInitialRequestString();this.oDbg.log(t,4),this._ws.onmessage=JSJaC.bind(this._handleOpenStream,this),this._ws.send(t)},JSJaCWebSocketConnection.prototype._handleOpenStream=function(t){var e,n;return this.oDbg.log(t.data,4),e=t.data,e=e.substr(e.indexOf("<stream:stream")),"/>"!==e.substr(-2)&&"</stream:stream>"!==e.substr(-16)&&(e+="</stream:stream>"),(n=this._parseXml(e))?(this.streamid=n.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),void(this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this))):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._handleInitialResponse=function(t){var e=this._parseXml(t.data);return this._parseStreamFeatures(e)?(this._connected=!0,void(this.register?this._doInBandReg():this._doAuth())):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting"),this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))},JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2),"disconnecting"!==this._status&&(this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")))},JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._onmessage=function(t){var e,n,r;if(e=t.data,this._setStatus("processing"),e&&""!==e){if(n=this._parseXml(e),n.namespaceURI===NS_STREAM&&"error"===n.localName)return n.getElementsByTagNameNS(NS_STREAMS,"conflict").length>0&&this._setStatus("session-terminate-conflict"),this._connected=!1,void this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));r=JSJaCPacket.wrapNode(n),r&&(this.oDbg.log("async recv: "+t.data,4),this._handleEvent("packet_in",r),r.pType&&!this._handlePID(r)&&(this._handleEvent(r.pType()+"_in",r),this._handleEvent(r.pType(),r)))}},JSJaCWebSocketConnection.prototype._parseXml=function(t){var e;this.oDbg.log("Parsing: "+t,4);try{if(e=XmlDocument.create("stream",NS_STREAM),"</stream:stream>"==t.trim()){this.oDbg.log("session terminated",1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(n){}return this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return t.indexOf("<stream:stream")===-1?(e.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+t+"</stream:stream>"),e.documentElement.firstChild):(e.loadXML(t),e.documentElement)}catch(n){this.oDbg.log("Error: "+n),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null},JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var t,e;return t=this.domain,this.authhost&&(t=this.authhost),e='<stream:stream to="'+t+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"',"sasl"!==this.authtype&&"saslanon"!==this.authtype||(e+=' version="1.0"'),e+=">"},JSJaCWebSocketConnection.prototype.send=function(t,e,n){if(!this.connected())return!1;if(!t||!t.pType)return this.oDbg.log("no packet: "+t,1),!1;this._ws.onmessage=JSJaC.bind(this._onmessage,this),e&&(t.getID()||t.setID("JSJaCID_"+this._ID++),this._registerPID(t,e,n));try{this._handleEvent(t.pType()+"_out",t),this._handleEvent("packet_out",t),this._ws.send(t.xml())}catch(r){return this.oDbg.log(r.toString(),1),!1}return!0},JSJaCWebSocketConnection.prototype.resume=function(){return!1},JSJaCWebSocketConnection.prototype.suspend=function(){return!1},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S1=function(t){var e=this._parseXml(t.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S1,this)(e)},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S2=function(t){var e=this._parseXml(t.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S2,this)(e)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(t){var e=this._parseXml(t.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(e)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(t){var e=this._parseXml(t.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(e)},JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(t){var e=this._parseXml(t.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(e)},JSJaCWebSocketConnection.prototype._reInitStream=function(t){var e,n=this.domain;this.authhost&&(n=this.authhost),e='<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+n+'" version="1.0">',this._sendRaw(e,t)},JSJaCWebSocketConnection.prototype._sendRaw=function(t,e,n){return!!this._ws&&(e&&(this._ws.onmessage=JSJaC.bind(e,this,n)),this._ws.send(t),!0)};var JSJaC={Version:"1.4",require:function(t){document.write('<script type="text/javascript" src="'+t+'"></script>')},load:function(){var t,e=["xmlextras","jsextras","crypt","JSJaCConfig","JSJaCConstants","JSJaCCookie","JSJaCJSON","JSJaCJID","JSJaCUtils","JSJaCBuilder","JSJaCPacket","JSJaCError","JSJaCKeys","JSJaCConnection","JSJaCHttpPollingConnection","JSJaCHttpBindingConnection","JSJaCConsoleLogger","JSJaCWebSocketConnection"],n=document.getElementsByTagName("script"),r="./";for(t=0;t<n.length;t++)if(n.item(t).src&&n.item(t).src.match(/JSJaC\.js$/)){r=n.item(t).src.replace(/JSJaC.js$/,"");break}for(t=0;t<e.length;t++)this.require(r+e[t]+".js")},bind:function(t,e,n){return function(r){return t.apply(e,[r,n])}}};"undefined"==typeof JSJaCConnection&&JSJaC.load();